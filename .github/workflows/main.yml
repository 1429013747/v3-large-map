# 工作流名称：前端项目 CI/CD（测试+构建+部署）
name: 前端项目 CI/CD

# 触发条件：
# 1. 代码推送到 main 分支时触发
# 2. 手动触发（在 Actions 页面点击“Run workflow”）
on:
  push:
    branches: [main]
  workflow_dispatch: # 允许手动触发

# 定义任务（Job）：所有任务在独立的 Runner 中执行
jobs:
  # 任务1：代码检查 + 单元测试
  test:
    runs-on: ubuntu-latest # 运行环境：GitHub 托管的 Ubuntu 最新版
    steps:
      # 步骤1：拉取仓库代码（必须第一步，获取最新代码）
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：设置 Node.js 环境（匹配项目的 Node 版本）
      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x # 替换为你的项目实际使用的 Node 版本（如 18.x）
          cache: npm # 缓存 npm 依赖，加速后续构建

      # 步骤3：安装项目依赖
      - name: 安装依赖
        run: npm install # 若用 pnpm/yarn，替换为 pnpm i / yarn install

      # 步骤4：代码检查（如 ESLint）
      - name: 代码检查
        run: npm run lint # 确保 package.json 中有 "lint": "eslint ." 脚本

      # 步骤5：运行单元测试（如 Jest/Vitest）
      # - name: 单元测试
      #   run: npm run test:unit # 确保 package.json 中有对应的测试脚本

  # 任务2：构建项目（依赖 test 任务成功完成）
  build:
    needs: test # 依赖 test 任务，test 成功后才会执行 build
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: 安装依赖
        run: npm install

      # 步骤：构建项目（生成静态文件，如 dist 目录）
      - name: 构建项目
        run: npm run build # 确保 package.json 中有 "build": "vue-tsc && vite build" 脚本

      # 步骤：将构建结果（dist）上传为“构建产物”，供后续部署任务使用
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: dist # 产物名称，后续部署任务用这个名称下载
          path: ./dist # 构建结果的目录（Vue 项目默认是 dist）

  # 任务3：部署到 GitHub Pages（依赖 build 任务成功完成）
  deploy:
    needs: build # 依赖 build 任务，build 成功后才会执行 deploy
    runs-on: ubuntu-latest
    # 授予必要的权限，允许推送到 gh-pages 分支
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      # 步骤1：下载 build 任务上传的构建产物（dist）
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: dist # 对应 build 任务中上传的产物名称
          path: ./dist # 下载到当前目录的 dist 文件夹

      # 步骤2：部署到 GitHub Pages（使用第三方 Action，简化部署）
      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # GitHub 自动生成的 Token，无需手动配置，用于授权部署
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist # 要部署的目录（即 build 生成的 dist）
